<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Stocks</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <!-- Google Tag Manager -->
    <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5WRLND4');
      </script>
  <!-- End Google Tag Manager -->
  
   </head>
    <body>
      <div class="static">
        <div class="search">
      <input placeholder="Search Sector..." type="text" id="filter" name="filter" />
      <ul id="SectorList">

      </ul>
      </div>
      
      
      <div class="Range">
        <button id="days20" class="d20" onclick="getDay(20);" type="button">20 Days</button>
        <button id="days50" class="d50"  onclick="getDay(50);" type="button">50 Days</button>
        <button id="days70" class="d20" onclick="getDay(70);" type="button">70 Days</button>
        <button id="days100" class="100"  onclick="getDay(100);" type="button">100 Days</button>
        <button id="results" onclick="get10x();">Stocks Result</button>
        
        <div class="dropdown">
            <button id="daysbuy" class="buy-main"  onclick="getBuyMain();" type="button">Buy List</button>
              <div id="BuyDropdown" class="drop-options">
                <button id="daysbuy40" class="buy"  onclick="getBuy(40);" type="button">40% +</button>
                <button id="daysbuy30" class="buy"  onclick="getBuy(30);" type="button">30% +</button>
                <button id="daysbuy20" class="buy"  onclick="getBuy(20);" type="button">20% +</button>
                <button id="daysbuyAvg" class="buy"  onclick="getBuy(60);" type="button">30d Avg +</button>
              </div>
        </div>
        
      </div>
    </div>
    
      <div class="charts"></div>
      <ol class="volume"> </0l>
<script>
let dCompanyObject = {};
let x10dCompanyObject = {};
let dE;
let BuyObject40 = {};
let BuyObject30 = {};
let BuyObject20 = {};
let BuyObject3Avg = {};

function getDay(days){
  removeActive();
//   event.target.classList.add('active');
  createChart(dCompanyObject, dE, days = days)
}
function removeActive(){
//   let lst = document.querySelectorAll("[id^='days']");
//   lst.forEach( element => element.classList.remove('active') );
}
function getBuyMain(){
  let lst = document.querySelectorAll(".buy");
  lst.forEach(element => {
    element.classList.toggle('show');    
  });

}
function getBuy(margin){
              removeActive();
            //   event.target.classList.add('active');
              switch(margin) {
                case 40:
                  createChart(BuyObject40, dE);
                  break;
                case 30:
                  createChart(BuyObject30, dE);
                  break;
                case 60:
                  createChart(BuyObject3Avg, dE);
                  break;
                default:
                  createChart(BuyObject20, dE);
              }
        getBuyMain(); 
}

function createChart(companyObject, e, days = 1000){

  let lst = document.querySelectorAll("canvas");
  lst.forEach(element => {
    element.remove();    
  });
  dE = e;
  let resultCount = 0;
      for (let key in companyObject) {
        resultCount++;
            let yValues  = [];
            yValues  = [...companyObject[key]];
            let xValues = [];
            let yValues2 = [];

              yValues.reverse();
              for(let y = 0; y < Math.min(companyObject[key].length, days) ; y++){
                yValues2[y] =  yValues[y] ;
              }
                  for (let i = 0; i < Math.min(companyObject[key].length, days) ; i++) {
                    xValues.push(i);
                  }
                  xValues.reverse();
          let divtag = document.createElement("div");
          // let imgtag = document.createElement("img");
          // imgtag.setAttribute("src",'/images/add.jpg');
          // divtag.appendChild(imgtag);
          let anchortag = document.createElement("a");
          anchortag.setAttribute("href", "https://www.screener.in/company/" + key + "/");
          anchortag.setAttribute("target", "_blank");
          anchortag.appendChild(divtag);
                      let canvas = document.createElement("canvas");
                      canvas.setAttribute("id", key);
                      canvas.setAttribute("class", key);
          divtag.appendChild(canvas);
                      document.querySelector(".charts").appendChild(anchortag);
                        // let cmax = Math.max(...yValues2);
                        let ccurrect = yValues2[0];
                        let cmin = Math.min(...yValues2);
                        let cmax = Math.max(...yValues2);
                        let buyAvg = [...yValues2];                        
                          if (Math.floor(((cmax-ccurrect)/cmax) * 100) > 40 && ccurrect < cmax){
                            BuyObject40[key] = companyObject[key];
                          }
                          else if (Math.floor(((cmax-ccurrect)/cmax) * 100) > 30 && ccurrect < cmax){
                            BuyObject30[key] = companyObject[key];
                          }
                          else if (Math.floor(((cmax-ccurrect)/cmax) * 100) > 20 && ccurrect < cmax){
                            BuyObject20[key] = companyObject[key];
                          }
                            
                          if (( ( (Number(buyAvg[20]) + Number(buyAvg[29]) + Number(buyAvg[15])) / 3) < (ccurrect * 1.09 )) && (((cmax-ccurrect)/cmax) * 100) > 30 ){
                            BuyObject3Avg[key] = companyObject[key];
                            console.log(key + "    " + ( (Number(buyAvg[20]) + Number(buyAvg[29]) + Number(buyAvg[15]) )/3).toFixed(2) + "    " + ccurrect);
                          }

                        
                          new Chart(canvas, {
                              type: "line",
                              data: {
                              labels: xValues,
                              datasets: [{
                                      label: key + '   FL ' + ( ((cmax-cmin)/cmax) * 100).toFixed(2).toString() + ' %  FC (' + ( ((cmax-ccurrect)/cmax) * 100).toFixed(2).toString() + ' )'  ,
                                      pointRadius: 0,
                                      borderWidth : 0.5,
                                      borderColor: "rgba(0,0,0,0.9)",
                                      data: [...yValues2].reverse(),
                                      }]
                                    }   
                              });

      }
document.getElementById("results").innerText = resultCount.toString();
let idlst = document.querySelectorAll(".sector");
idlst.forEach( element => {
//   element.classList.remove('active');
})



// document.getElementById(event.target.id).classList.add('active');
}

    </script>
<script type="text/javascript">

function getData() {
        // removeActive();
        document.getElementById("filter").value = event.target.innerText;
        event.target.parentElement.style.display = 'none';
        // document.getElementById("getData" + e).innerText = "Loading...";
        event.target.classList.add('active');
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/" + event.target.id.toString());
        xhr.send();
        xhr.responseType = "json";
        xhr.onload = () => {
          if (xhr.readyState == 4 && xhr.status == 200) {
            dCompanyObject = xhr.response.companyObject;
            createChart( xhr.response.companyObject, event.target.id);
          } 
          else {
            console.log(`Error: ${xhr.status}`);
            }
          };
  }

  

 
    </script>
  

  <script>
// Search Bar Script to filter charts matching the typed text
function setFilter(){
    let filterData = (document.querySelector("#filter").value).toUpperCase();
    if ( filterData.length > 0) {
        var lst = Array.from(document.getElementsByTagName("canvas"));
        lst.forEach( (ele) => ele.style.display = "none" );
        lst = Array.from(document.querySelectorAll("[class^= '" + filterData + "']"));
        lst.forEach( ele => ele.style.display = "block" ); 
    }

    else{
      let lst = document.querySelectorAll("canvas");
      lst.forEach( ele => ele.style.display = "block" );
    }
    }



function letsDebounce(fn,d){
    let timer;
    return function(){
    clearTimeout(timer);
    timer=setTimeout(fn,d);
    }
}


  </script>

<style type="text/css">
#SectorList li{
font-size: 20px;
font-family: 'Courier New', Courier, monospace;
margin: 5px;

}
.volume{
  text-align: left;
  margin-left: 50px;
}
  .charts{
   margin: auto;
   text-align: -webkit-center;
   max-width: 500px;
   margin-top: 330px;
   }
   [id^='getData'], button{
   background-color: #FFD700;
   border: none;
   border-radius: 10px;
   height: 30px;
   margin: auto;
   width: 45%;
   margin:8px;
   }
   body{
     min-width: 350px;
   }
   .search{
     display: flex;
     width: 45%;
     margin-left: 15px;
   }
   .search input{
     height: 30px;
   }
   canvas{
     margin: 15px 0;
     /* max-width: 400px !important; */
     min-width: 320px !important;
     height: 200px !important;
     max-width: 99%;
   }
   #SectorList{
    display: block;
    z-index: 100;
    position: absolute;
    list-style: none;
    background-color: aliceblue;
    line-height: 1.5;
    border: 1px #000 solid;
    margin-top: 40px;
    /* display: none; */
    width: 200px;
   }
   .static{
     position: fixed;
     opacity: 1;
     background-color: #fff;
     top: 0;
     margin: 0;
     display: flex;
     flex-wrap: wrap;
    justify-content: space-betweenq;
   }
   .hide{
     display: none !important;
   }
   label{
     margin: 5px 10px;
     display: inline-block;
     width: 50px;
   }
   #filter{
     min-width: 70%;
     max-width: 80%;
     width: auto;
     height: 30px;
   }
   .Range{
     position: relative;
     display: flex;
     width: 100%;
     flex-wrap: wrap;
     justify-content: space-between;
   }

   .Range button{
     width:20% ;
   }
   .active{
     /* background-Color : rgb(0, 168, 0); */
   }

   .buy{
     position: relative;
     display: none;
   }
   .show{
     display: block;
   }
   .dropdown{
     width: 20%;
   }
   .dropdown button{
     width: 90%;
   }
   #results{
     width: 70%;
   }
   .volume li{
      margin: 20px 50px;
      padding: 0 30px;

   }
   /* .hide{
     display: none;
   } */
   /* .drop-options button{
       width: 20%;
       margin: 0;
   } */
 </style>
 <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5WRLND4"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1FNLLPDQHW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1FNLLPDQHW');
</script>
</script>

<script>

    const SectList = [  'Metals',
                        'Finance',
                        'Computers',
                        'Diversified',
                        'Engineering',
                        'Oil Drilling',
                        'Pharmaceuticals ',
                        'Chemicals',
                        'Textiles',
                        'Miscellaneous',
                        'Electric Equipment',
                        'Cement ',
                        'Trading',
                        'Power Generation And Supply',
                        'Food ',
                        'Electrodes ',
                        'Hotels',
                        'Petrochemicals',
                        'Packaging',
                        'Fertilizers',
                        'Steel ',
                        'Construction',
                        'Castings ',
                        'Leather ',
                        'Dyes And Pigments',
                        'Cables ',
                        'Paints ',
                        'Auto Ancillaries',
                        'Electronics ',
                        'Paper',
                        'Aquaculture',
                        'Healthcare',
                        'Plastics Products',
                        'Tyres',
                        'Glass ',
                        'Breweries ',
                        'Mining ',
                        'Engineering ',
                        'Automobiles ',
                        'Ceramics ',
                        'Pesticides ',
                        'Telecommunications ',
                        'Solvent Extraction',
                        'Banks ',
                        'Sugar',
                        'Entertainment ',
                        'Personal Care ',
                        'Domestic Appliances',
                        'Cement Products',
                        'Couriers',
                        'Air',
                        'Refineries',
                        'Abrasives And Grinding Wheels',
                        'Tea',
                        'Aluminium and Aluminium Products',
                        'Engines',
                        'Diamond Cutting ',
                        'Travel Agencies',
                        'Compressors ',
                        'Shipping',
                        'Dry Cells',
                        'Detergents ',
                        'Transport ',
                        'Cigarettes',
                        'Chlor Alkali ',
                        'Refractories ',
                        'Recreation ',
                        'Textile Machinery',
                        'Transmisson Line Towers ',
                        'Pumps',
                        'Printing ',
                        'Bearings',
                        'Moulded Luggage',
                        'Fasteners',
                        'Photographic And Allied Products'

                    ];
    
                        SectList.forEach( element =>{
                        // let btn = document.createElement('button');
                        // btn.addEventListener('click', getData)
                          let ls =   document.createElement("li");
                          ls.addEventListener('click', getData);
                          ls.innerText = element.trim();
                          ls.id = element.trim();
                          document.getElementById("SectorList").appendChild(ls);
                        })
            function myFunction() {
                document.getElementById("SectorList").style.display = 'block';
              // Declare variables
              var input, filter, ul, li, a, i, txtValue;
              input = document.getElementById('filter');
              filter = input.value.toUpperCase();
              ul = document.getElementById("SectorList");
              li = ul.getElementsByTagName('li');
            
              // Loop through all list items, and hide those who don't match the search query
              for (i = 0; i < li.length; i++) {
                txtValue = li[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                  li[i].style.display = "";
                } else {
                  li[i].style.display = "none";
                }
              }
            }
let myFunc = letsDebounce(myFunction,1000);
document.getElementById("filter").addEventListener('input', myFunc);
            </script>
</body>
</html>
